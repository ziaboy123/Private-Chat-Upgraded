<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Chat Room: {{code}} - The Rooms</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
        <link
        rel="stylesheet"
        href="{{url_for('static', filename='css/style.css')}}"
        />
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
            integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
            crossorigin="anonymous"
        ></script>
    </head>
    <body>
        <div class="content">
        
<div class="message-box">
  <h2>Chat Room: {{code}}</h2>
  <div class="messages" id="messages"></div>
  <div class="typing-indicator" id="typing-indicator"></div>
  <div class="inputs">
    <input
      type="text"
      rows="3"
      placeholder="Message"
      name="message"
      id="message"
    />
    <button type="button" name="send" id="send-btn">
      Send
    </button>
  </div>
</div>
<script type="text/javascript">
  var socketio = io();

  const messages = document.getElementById("messages");
  const typingIndicator = document.getElementById("typing-indicator");
  const messageInput = document.getElementById("message");
  let typingUsers = new Set();

  const updateTypingIndicator = () => {
    if (typingUsers.size === 0) {
      typingIndicator.textContent = "";
      typingIndicator.style.display = "none";
      return;
    }

    typingIndicator.style.display = "block";
    const users = Array.from(typingUsers);
    if (users.length === 1) {
      typingIndicator.textContent = `${users[0]} is typing...`;
    } else if (users.length === 2) {
      typingIndicator.textContent = `${users[0]} and ${users[1]} are typing...`;
    } else {
      typingIndicator.textContent = "Several people are typing...";
    }
  };

  socketio.on("user_typing", (data) => {
    typingUsers.add(data.name);
    updateTypingIndicator();
  });

  socketio.on("user_stop_typing", (data) => {
    typingUsers.delete(data.name);
    updateTypingIndicator();
  });
  
  const createStatusMessage = (msg) => {
    const messageWrapper = document.createElement("div");
    messageWrapper.classList.add("status-message");
    messageWrapper.textContent = msg;
    messages.appendChild(messageWrapper);
  };

  const createMessage = (name, msg) => {
    // Create elements programmatically to prevent XSS attacks.
    // This ensures that any HTML/script tags in the message are treated as plain text.
    const messageWrapper = document.createElement("div");
    messageWrapper.classList.add("text");

    const messageContent = document.createElement("span");
    const strong = document.createElement("strong");
    strong.textContent = `${name}: `;
    messageContent.appendChild(strong);
    // Use createTextNode to safely render the message content
    messageContent.appendChild(document.createTextNode(msg));

    const timestamp = document.createElement("span");
    timestamp.classList.add("muted");
    timestamp.textContent = new Date().toLocaleString();

    messageWrapper.appendChild(messageContent);
    messageWrapper.appendChild(timestamp);

    messages.appendChild(messageWrapper);
    // Auto-scroll to the bottom to see the new message
    messages.scrollTop = messages.scrollHeight;
  };

  socketio.on("message", (data) => {
    createMessage(data.name, data.message);
  });

  socketio.on("status", (data) => {
    createStatusMessage(data.msg);
  });

  const sendMessage = () => {
    if (messageInput.value == "") return;
    socketio.emit("message", { data: messageInput.value });
    messageInput.value = "";
  };

  let typingTimer;
  let isTyping = false;
  const typingTimeout = 1500; // 1.5 seconds

  // Use addEventListener for cleaner, more modern event handling
  document.getElementById("send-btn").addEventListener("click", sendMessage);

  // Add ability to send message by pressing "Enter"
  messageInput.addEventListener("keypress", function (e) {
    if (e.key === "Enter") {
      sendMessage();
    }
  });

  // Listen for input on the message field to detect typing
  messageInput.addEventListener("input", () => {
    if (!isTyping) {
      isTyping = true;
      socketio.emit("typing");
    }
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
      isTyping = false;
      socketio.emit("stop_typing");
    }, typingTimeout);
  });
</script>
{% for msg in messages %}
<script type="text/javascript">
  {% if msg.type == 'message' %}
    createMessage("{{msg.name | e}}", "{{msg.message | e}}");
  {% elif msg.type == 'status' %}
    createStatusMessage("{{msg.msg | e}}");
  {% endif %}
</script>
{% endfor %}

</div>
    </body>
</html>